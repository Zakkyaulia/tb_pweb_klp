<%- include('../partials/admin-header', {title: 'Kelola Pengguna'}) %>
<%- include('../partials/navbar') %>
        <div class="main-content flex-1 p-6">
            <div class="main-header flex justify-between items-center mb-6">
                <h1 class="page-title text-3xl font-semibold text-white">Kelola Pengguna</h1>
                <i class="fas fa-user-circle user-icon text-white text-2xl cursor-pointer transition-colors duration-200 ease-in-out hover:text-green-100"></i>
            </div>
            <div class="content-card bg-white rounded-xl shadow-lg p-8 animate-fade-in">
                <table class="min-w-full text-left border-collapse">
                    <thead class="table-header text-white">
                        <tr>
                            <th class="py-2 px-4">Nama</th>
                            <th class="py-2 px-4">NIM</th>
                            <th class="py-2 px-4">Jurusan</th>
                            <th class="py-2 px-4">Aksi</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% if (users.length > 0) { %>
                            <% users.forEach(user => { %>
                                <tr class="border-b border-gray-200 hover:bg-gray-100">
                                    <td class="py-2 px-4"><%= user.nama %></td>
                                    <td class="py-2 px-4"><%= user.nim %></td>
                                    <td class="py-2 px-4"><%= user.jurusan %></td>
                                    <td class="py-2 px-4">
                                        <button 
                                            data-user-id="<%= user.user_id %>"
                                            data-user-name="<%= user.nama %>"
                                            onclick="confirmDelete(this)" 
                                            class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm transition-colors duration-200 btn-hover">
                                            <i class="fas fa-trash mr-1"></i>Hapus
                                        </button>
                                    </td>
                                </tr>
                            <% }); %>
                        <% } else { %>
                            <tr>
                                <td colspan="4" class="py-2 px-4 text-center text-gray-500">Tidak ada data pengguna.</td>
                            </tr>
                        <% } %>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Popup Konfirmasi Hapus -->
    <div id="deleteModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
            <div class="flex items-center mb-4">
                <div class="bg-red-100 rounded-full p-2 mr-3">
                    <i class="fas fa-exclamation-triangle text-red-600"></i>
                </div>
                <h3 class="text-lg font-semibold text-gray-900">Konfirmasi Hapus</h3>
            </div>
            <p class="text-gray-600 mb-6" id="deleteMessage">
                Apakah Anda yakin ingin menghapus user ini?
            </p>
            <div class="flex justify-end space-x-3">
                <button 
                    onclick="closeDeleteModal()" 
                    class="px-4 py-2 text-gray-600 bg-gray-200 rounded hover:bg-gray-300 transition-colors duration-200 btn-hover">
                    Batal
                </button>
                <button 
                    id="confirmDeleteBtn"
                    class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600 transition-colors duration-200 btn-hover">
                    Hapus
                </button>
            </div>
        </div>
    </div>

    <!-- Popup Sukses -->
    <div id="successModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4 transform transition-all duration-300 scale-95 opacity-0" id="successModalContent">
            <div class="flex items-center mb-4">
                <div class="bg-green-100 rounded-full p-3 mr-3">
                    <i class="fas fa-check-circle text-green-600 text-xl"></i>
                </div>
                <h3 class="text-lg font-semibold text-gray-900">Berhasil!</h3>
            </div>
            <p class="text-gray-600 mb-6" id="successMessage">
                User berhasil dihapus!
            </p>
            <div class="flex justify-end">
                <button 
                    onclick="closeSuccessModal()" 
                    class="px-6 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors duration-200 font-medium btn-hover">
                    OK
                </button>
            </div>
        </div>
    </div>

    <!-- Popup Error -->
    <div id="errorModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4 transform transition-all duration-300 scale-95 opacity-0" id="errorModalContent">
            <div class="flex items-center mb-4">
                <div class="bg-red-100 rounded-full p-3 mr-3">
                    <i class="fas fa-times-circle text-red-600 text-xl"></i>
                </div>
                <h3 class="text-lg font-semibold text-gray-900">Error!</h3>
            </div>
            <p class="text-gray-600 mb-6" id="errorMessage">
                Terjadi kesalahan!
            </p>
            <div class="flex justify-end">
                <button 
                    onclick="closeErrorModal()" 
                    class="px-6 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors duration-200 font-medium btn-hover">
                    OK
                </button>
            </div>
        </div>
    </div>

    <script>
        let currentUserId = null;

        function confirmDelete(button) {
            const userId = button.getAttribute('data-user-id');
            const userName = button.getAttribute('data-user-name');
            
            currentUserId = userId;
            
            document.getElementById('deleteMessage').textContent = `Apakah Anda yakin ingin menghapus user "${userName}"?`;
            document.getElementById('deleteModal').classList.remove('hidden');
        }

        function closeDeleteModal() {
            document.getElementById('deleteModal').classList.add('hidden');
            currentUserId = null;
        }

        document.getElementById('confirmDeleteBtn').addEventListener('click', async function() {
            if (!currentUserId) return;

            try {
                console.log('Sending delete request for user ID:', currentUserId);
                const response = await fetch(`/admin/users/${currentUserId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                console.log('Response status:', response.status);
                const result = await response.json();
                console.log('Response result:', result);

                if (result.success) {
                    showSuccessModal('User berhasil dihapus!');
                } else {
                    showErrorModal('Gagal menghapus user: ' + result.message);
                }
            } catch (error) {
                console.error('Error:', error);
                showErrorModal('Terjadi kesalahan saat menghapus user: ' + error.message);
            }

            closeDeleteModal();
        });

        // Tutup modal jika klik di luar modal
        document.getElementById('deleteModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeDeleteModal();
            }
        });

        // Tutup popup sukses jika klik di luar modal
        document.getElementById('successModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeSuccessModal();
            }
        });

        // Tutup popup error jika klik di luar modal
        document.getElementById('errorModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeErrorModal();
            }
        });

        function closeSuccessModal() {
            const modal = document.getElementById('successModal');
            const content = document.getElementById('successModalContent');
            
            content.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                modal.classList.add('hidden');
                content.classList.remove('scale-95', 'opacity-0');
                window.location.reload();
            }, 300);
        }

        function closeErrorModal() {
            const modal = document.getElementById('errorModal');
            const content = document.getElementById('errorModalContent');
            
            content.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                modal.classList.add('hidden');
                content.classList.remove('scale-95', 'opacity-0');
            }, 300);
        }

        function showSuccessModal(message) {
            const modal = document.getElementById('successModal');
            const content = document.getElementById('successModalContent');
            
            document.getElementById('successMessage').textContent = message;
            modal.classList.remove('hidden');
            
            setTimeout(() => {
                content.classList.remove('scale-95', 'opacity-0');
                content.classList.add('scale-100', 'opacity-100');
            }, 10);
        }

        function showErrorModal(message) {
            const modal = document.getElementById('errorModal');
            const content = document.getElementById('errorModalContent');
            
            document.getElementById('errorMessage').textContent = message;
            modal.classList.remove('hidden');
            
            setTimeout(() => {
                content.classList.remove('scale-95', 'opacity-0');
                content.classList.add('scale-100', 'opacity-100');
            }, 10);
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Beri sedikit jeda untuk memastikan skrip ini berjalan setelah skrip lain
            setTimeout(() => {
                const permintaanSubmenu = document.querySelector('.nav-submenu');
                if (permintaanSubmenu && permintaanSubmenu.classList.contains('active')) {
                    // Tutup submenu hanya jika sedang terbuka
                    permintaanSubmenu.classList.remove('active');
                    const submenuList = permintaanSubmenu.querySelector('.submenu-list');
                    const chevron = permintaanSubmenu.querySelector('.submenu-header i');
                    
                    submenuList.style.maxHeight = '0';
                    if (chevron) {
                        chevron.style.transform = 'rotate(0deg)';
                    }
                }
            }, 0); // Jeda 0 milidetik sudah cukup untuk memindahkannya ke akhir antrian eksekusi
        });
    </script>
<%- include('../partials/admin-footer') %> 