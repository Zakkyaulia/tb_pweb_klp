<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Riwayat Surat - SIPAS</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <script>
    function showWarningPopup(message) {
      // Create custom warning dialog
      const warningDiv = document.createElement('div');
      warningDiv.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
      warningDiv.innerHTML = `
        <div class="bg-white rounded-lg p-6 max-w-sm mx-4 shadow-xl">
          <div class="flex items-center mb-4">
            <div class="w-10 h-10 bg-yellow-100 rounded-full flex items-center justify-center mr-3">
              <i class="fas fa-exclamation-triangle text-yellow-600"></i>
            </div>
            <h3 class="text-lg font-semibold text-gray-900">Peringatan</h3>
          </div>
          <p class="text-gray-600 mb-6">${message}</p>
          <div class="flex justify-end">
            <button onclick="this.closest('.fixed').remove()" 
                    class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
              OK
            </button>
          </div>
        </div>
      `;
      document.body.appendChild(warningDiv);
    }

    function editRequest(id, status) {
      if (status === 'diproses') {
        showWarningPopup('Pengajuan tidak dapat diedit karena sudah diproses');
        return;
      }
      if (status === 'selesai') {
        showWarningPopup('Pengajuan tidak dapat diedit karena sudah selesai');
        return;
      }
      window.location.href = `/request/edit/${id}`;
    }

    function deleteRequest(id, status) {
      if (status === 'diproses') {
        showWarningPopup('Pengajuan tidak dapat dihapus karena sudah diproses');
        return;
      }
      if (status === 'selesai') {
        showWarningPopup('Pengajuan tidak dapat dihapus karena sudah selesai');
        return;
      }
      
      // Create custom confirmation dialog
      const confirmDiv = document.createElement('div');
      confirmDiv.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
      confirmDiv.innerHTML = `
        <div class="bg-white rounded-lg p-6 max-w-sm mx-4 shadow-xl">
          <div class="flex items-center mb-4">
            <div class="w-10 h-10 bg-red-100 rounded-full flex items-center justify-center mr-3">
              <i class="fas fa-exclamation-triangle text-red-600"></i>
            </div>
            <h3 class="text-lg font-semibold text-gray-900">Konfirmasi Hapus</h3>
          </div>
          <p class="text-gray-600 mb-6">Apakah Anda yakin ingin menghapus pengajuan surat ini?</p>
          <div class="flex justify-end space-x-3">
            <button onclick="this.closest('.fixed').remove()" 
                    class="px-4 py-2 text-gray-600 bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors">
              Batal
            </button>
            <button onclick="confirmDelete(${id})" 
                    class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors">
              Hapus
            </button>
          </div>
        </div>
      `;
      document.body.appendChild(confirmDiv);
    }

    function confirmDelete(id) {
      // Remove the confirmation dialog
      document.querySelector('.fixed').remove();
      
      // Send delete request
      fetch(`/request/delete/${id}`, {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json',
        }
      })
      .then(response => {
        if (response.ok) {
          // Reload the page to show updated data
          window.location.reload();
        } else {
          alert('Gagal menghapus pengajuan surat');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Terjadi kesalahan saat menghapus pengajuan surat');
      });
    }
  </script>
</head>
<body class="bg-green-700 font-sans">
  <%- include('partials/header', { active: 'Riwayat' }) %>

  <main class="max-w-6xl mx-auto mt-10 p-8 bg-white rounded-xl shadow mb-10">
    <h2 class="text-xl font-bold text-white bg-orange-400 px-4 py-2 rounded-t-xl">Riwayat Surat</h2>

    <% if (typeof error !== 'undefined' && error) { %>
      <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4 mt-4" role="alert">
        <strong class="font-bold">Error!</strong>
        <span class="block sm:inline"><%= error %></span>
      </div>
    <% } %>

    <div class="mt-4">
      <label class="block text-gray-600 mb-2 font-semibold">Jenis Surat</label>
      <select onchange="location.href='/riwayat?filter=' + this.value"
              class="w-full md:w-1/3 h-12 rounded-xl border-2 border-orange-400 px-4">
        <option value="Semua" <%= filter === 'Semua' ? 'selected' : '' %>>Semua Jenis Surat</option>
        <option value="SKAK" <%= filter === 'SKAK' ? 'selected' : '' %>>Surat Keterangan Aktif Kuliah</option>
        <option value="SKL" <%= filter === 'SKL' ? 'selected' : '' %>>Surat Keterangan Lulus</option>
        <option value="SBSS" <%= filter === 'SBSS' ? 'selected' : '' %>>Surat Berhenti Studi Sementara</option>
        <option value="SAK" <%= filter === 'SAK' ? 'selected' : '' %>>Surat Aktif Kembali</option>
        <option value="SKTMB" <%= filter === 'SKTMB' ? 'selected' : '' %>>Surat Keterangan Tidak Menerima Beasiswa</option>
      </select>
    </div>

    <div class="hidden md:block overflow-x-auto mt-6">
      <table class="w-full text-left border-collapse">
        <thead>
          <tr class="bg-orange-500 text-white">
            <th class="px-4 py-3">Nama</th>
            <th class="px-4 py-3">NIM</th>
            <th class="px-4 py-3">Jurusan</th>
            <th class="px-4 py-3">Tanggal</th>
            <th class="px-4 py-3">Jenis Surat</th>
            <th class="px-4 py-3">Status</th>
            <th class="px-4 py-3 text-center">Aksi</th>
          </tr>
        </thead>
        <tbody>
          <% if (data.length === 0) { %>
            <tr>
              <td colspan="7" class="px-4 py-8 text-center text-gray-500">
                <i class="fas fa-inbox text-4xl mb-4 block"></i>
                Belum ada data pengajuan
              </td>
            </tr>
          <% } else { %>
            <% data.forEach(item => { %>
              <%
                const displayStatus = item.status === 'selesai' ? 'Selesai' : (item.status === 'diajukan' ? 'Diajukan' : item.status === 'diproses' ? 'Diproses' : item.status === 'disetujui' ? 'Disetujui' : item.status);
                const tanggal = new Date(item.tanggal_request).toLocaleDateString('id-ID');
              %>
              <tr class="border-b hover:bg-gray-50">
                <td class="px-4 py-3"><%= item.nama %></td>
                <td class="px-4 py-3"><%= item.nim %></td>
                <td class="px-4 py-3"><%= item.jurusan %></td>
                <td class="px-4 py-3"><%= tanggal %></td>
                <td class="px-4 py-3"><%= item.nama_lengkap_surat %></td>
                <td class="px-4 py-3">
                  <span class="px-2 py-1 rounded-full text-xs font-semibold
                    <% if (item.status === 'diproses') { %>bg-yellow-100 text-yellow-800<% } %>
                    <% if (item.status === 'selesai') { %>bg-green-100 text-green-800<% } %>
                    <% if (item.status === 'diajukan') { %>bg-blue-100 text-blue-800<% } %>
                    <% if (item.status === 'disetujui') { %>bg-emerald-100 text-emerald-800<% } %>">
                    <%= displayStatus %>
                  </span>
                </td>
                <td class="px-4 py-3">
                  <div class="flex justify-center space-x-1">
                    <a href="#"
                       class="bg-blue-500 hover:bg-blue-600 text-white p-2 rounded-lg text-sm transition-colors duration-200"
                       title="Lihat Detail">
                      <i class="fas fa-eye"></i>
                    </a>
                    <button onclick="editRequest(<%= item.id %>, '<%= item.status %>')"
                            class="bg-orange-500 hover:bg-orange-600 text-white p-2 rounded-lg text-sm transition-colors duration-200"
                            title="Edit">
                      <i class="fas fa-edit"></i>
                    </button>
                    <button onclick="deleteRequest(<%= item.id %>, '<%= item.status %>')"
                            class="bg-red-500 hover:bg-red-600 text-white p-2 rounded-lg text-sm transition-colors duration-200"
                            title="Hapus">
                      <i class="fas fa-trash"></i>
                    </button>
                  </div>
                </td>
              </tr>
            <% }) %>
          <% } %>
        </tbody>
      </table>
    </div>

    <div class="md:hidden mt-6 space-y-4">
      <% if (data.length === 0) { %>
        <div class="text-center py-8 text-gray-500">
          <i class="fas fa-inbox text-4xl mb-4 block"></i>
          Belum ada data pengajuan
        </div>
      <% } else { %>
        <% data.forEach(item => { %>
          <%
            const displayStatus = item.status === 'selesai' ? 'Selesai' : (item.status === 'diajukan' ? 'Diajukan' : item.status === 'diproses' ? 'Diproses' : item.status === 'disetujui' ? 'Disetujui' : item.status);
            const tanggal = new Date(item.tanggal_request).toLocaleDateString('id-ID');
          %>
          <div class="bg-white border rounded-lg p-4 shadow-sm">
            <div class="flex justify-between items-start mb-3">
              <div>
                <h3 class="font-semibold text-gray-800"><%= item.nama %></h3>
                <p class="text-sm text-gray-600">NIM: <%= item.nim %></p>
                <p class="text-sm text-gray-600">Jurusan: <%= item.jurusan %></p>
              </div>
              <span class="px-2 py-1 rounded-full text-xs font-semibold
                <% if (item.status === 'diproses') { %>bg-yellow-100 text-yellow-800<% } %>
                <% if (item.status === 'selesai') { %>bg-green-100 text-green-800<% } %>
                <% if (item.status === 'diajukan') { %>bg-blue-100 text-blue-800<% } %>
                <% if (item.status === 'disetujui') { %>bg-emerald-100 text-emerald-800<% } %>">
                <%= displayStatus %>
              </span>
            </div>
            <div class="text-sm text-gray-600 mb-3">
              <p><strong>Tanggal:</strong> <%= tanggal %></p>
              <p><strong>Jenis:</strong> <%= item.nama_lengkap_surat %></p>
            </div>
            <div class="flex justify-center space-x-2">
              <a href="#"
                 class="bg-blue-500 hover:bg-blue-600 text-white p-2 rounded-lg text-sm transition-colors duration-200"
                 title="Lihat Detail">
                <i class="fas fa-eye"></i>
              </a>
              <button onclick="editRequest(<%= item.id %>, '<%= item.status %>')"
                      class="bg-orange-500 hover:bg-orange-600 text-white p-2 rounded-lg text-sm transition-colors duration-200"
                      title="Edit">
                <i class="fas fa-edit"></i>
              </button>
              <button onclick="deleteRequest(<%= item.id %>, '<%= item.status %>')"
                      class="bg-red-500 hover:bg-red-600 text-white p-2 rounded-lg text-sm transition-colors duration-200"
                      title="Hapus">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
        <% }) %>
      <% } %>
    </div>
  </main>
</body>
</html>